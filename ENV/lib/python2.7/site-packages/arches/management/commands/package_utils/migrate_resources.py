import os
import sys
import traceback
import unicodecsv
from os import listdir
from os.path import isfile, join
import arches.app.models.models as models
from arches.app.models.entity import Entity
from arches.app.models.resource import Resource

from itertools import groupby

import logging

# Script for migrating business data from one part of resource graph to elsewhere.
# Typically this will be part of a migration from one resource graph to another, after adding new parts from the new resource graph, but before removing old ones.
# The migration is carried out according to a csv which specifies which entities must be created or altered.


def migrate(settings=None):
    
    # Load csv files
    # parse csv file
    
    if not settings:
        from django.conf import settings
    
    suffix = '_altered_nodes.csv'
    errors = []
    
    for path in settings.ADDITIONAL_RESOURCE_GRAPH_LOCATIONS:
        if os.path.exists(path):
            print '\nLOADING NODE MIGRATION INFO (%s)' % (path)
            print '--------------'
            for f in listdir(path):
                if isfile(join(path, f)) and f.endswith(suffix):
                    path_to_file = join(path,f)
                    basepath = path_to_file[:-18]
                    name = basepath.split(os.sep)[-1]
                    
                    migrations = get_list_dict(basepath + '_altered_nodes.csv', ['OLDENTITYTYPEID', 'NEWENTITYTYPEID', 'GROUPROOTNODEOLD', 'GROUPROOTNODENEW'])
                
                    # include any rules about observed property nodes which must be inserted
                    for migration in migrations:
                        for parent in settings.ADD_OBSERVED_NEAR:
                            if settings.ADD_OBSERVED_NEAR[parent][0] == migration['NEWENTITYTYPEID']:
                                migration['INSERT_NODE_RULE'] = (parent, settings.ADD_OBSERVED_NEAR[parent])
                    
                    
                    # Identify nodes which must be migrated
                    resource_entity_type = 'HERITAGE_RESOURCE_GROUP.E27'
                    mapping_schema = Entity.get_mapping_schema(resource_entity_type)
                    
                    # group migrations by groupRootNodeNew
                    groups = groupby(migrations, lambda x:(x['GROUPROOTNODEOLD'], x['GROUPROOTNODENEW']))
                    
                    for group_root_node_ids, group_migrations in groups:
                        
                        #Convert group_migrations to a list as we need to iterate it multiple times
                        group_migrations_list = []
                        for group_migration in group_migrations:
                            group_migrations_list.append(group_migration)
                        
                        group_root_node_id = group_root_node_ids[0]
                        new_group_root_node_id = group_root_node_ids[1]
                        
                        #Find all entities with the old group root node
                        group_root_entities = models.Entities.objects.all().filter(entitytypeid=group_root_node_id)
                        
                        for group_root_entity_model in group_root_entities:
                            # Create a new subgraph for each of the migration steps, then merge them together at the group root node
                            
                            #get full resource graph for the root entity
                            group_root_entity = Entity(group_root_entity_model.pk)
                            
                            # create a node for the new group root
                            new_group_root_entity = Entity().create_from_mapping(resource_entity_type, mapping_schema[new_group_root_node_id]['steps'], new_group_root_node_id, '')
                            
                            # get the root resource graph for this entity
                            resource_model = get_resource_for_entity(group_root_entity, resource_entity_type)
                            resource = Resource().get(resource_model.entityid)
                            
                            
                            for group_migration in group_migrations_list:
                                
                                # get individual entities to be migrated in the source group
                                old_entities = group_root_entity.find_entities_by_type_id(group_migration['OLDENTITYTYPEID'])
                                
                                for old_entity in old_entities:
                                    # Create the corresponding entity in the new schema
                                    new_entity = Entity()
                                    new_entity_type_id = group_migration['NEWENTITYTYPEID']
                                    new_entity.create_from_mapping(resource_entity_type, mapping_schema[new_entity_type_id]['steps'], new_entity_type_id, old_entity.value)
                                    
                                    # If there is a node to be inserted, do it here
                                    if 'INSERT_NODE_RULE' in group_migration:
                                        entityttypeid_to_insert = group_migration['INSERT_NODE_RULE'][1][1]
                                        value_to_insert = group_migration['INSERT_NODE_RULE'][1][2]
                                        
                                        inserted_entity = Entity()
                                        inserted_entity.create_from_mapping(resource_entity_type, mapping_schema[entityttypeid_to_insert]['steps'], entityttypeid_to_insert, value_to_insert)
                                        
                                        new_entity.merge(inserted_entity)
                                        
                                    # If there is a node in common with the existing node further down the chain than the group root node, merge there
                                    # follow links back from the parent
                    
                                    has_merged = False
                                    
                                    reversed_steps = mapping_schema[new_entity_type_id]['steps'][::-1]
                                    for step in reversed_steps:
                                        # find the entitytypedomain in the new_group_root_entity
                                        if not has_merged:
                                            mergeable_nodes = new_group_root_entity.find_entities_by_type_id(step['entitytypedomain'])
                                            if len(mergeable_nodes) > 0:
                                                new_group_root_entity.merge_at(new_entity, step['entitytypedomain'])
                                                has_merged = True
                                    
                                    if not has_merged:
                                        logging.warning("Unable to merge newly created entity")
                                    
                                    
                                # merge the new group root entity into the resource
                                resource.merge_at(new_group_root_entity, resource_entity_type)
                            
                            
                            # save the resource
                            resource.trim()
                            resource._save()
                            # resource.index()
                            logging.warning("SAVED RESOURCE, %s", resource)
                            
                            
                        
                        # TODO leave this blank?
                        # if not group_root_node_id:
                        #     #No grouping of these nodes. Just insert the new ones.
                        #     
                        #     for migration in migrations:
                        #         # For each node to be migrated
                        #         node_id = migration['OLDENTITYTYPEID']
                        #         
                        #         # Find affected entities
                        #         entities = models.Entities.objects.all().filter(entitytypeid=node_id)
                        #         
                        #         
                        #         new_type_id = migration['NEWENTITYTYPEID']
                        #         
                        #         for resource_entity in entities:
                        #             # create a new entity with the value taken from the old type
                        #             
                        #             # load the original entity from the database
                        #             original_entity = Entity(resource_entity.pk)
                        #             
                        #             # Find the full resource the source entity came from
                        #             # Trace back through entity relations until we arrive the root type
                        #             resource_model = get_resource_for_entity(resource_entity)
                        #             resource = Resource(resource_model.pk)
                        #             resource.set_entity_value(new_type_id, original_entity.value, append=True)
                        #             log_entity(resource)
                        #             resource._save()
                        #             resource.index()
                        #         
                        
                        #TODO check that the resource looks as it should
                        #TODO create observed property nodes during this migration
                        #TODO create actor nodes during this migration
        

def log_entity(entity):
    def do_log(subentity):
        logging.warning("--%s--", subentity)
    logging.warning("------Logging entity")
    entity.traverse(do_log)
    logging.warning("------End log entity")

def get_resource_for_entity(entity, resource_entity_type_id):
    parent = entity
    typeid = parent.entitytypeid
    try:
        while typeid != resource_entity_type_id:
            relationship = models.Relations.objects.all().get(entityidrange=parent.entityid)
            parent = relationship.entityiddomain
            typeid = parent.entitytypeid.pk
        return parent
    except Exception as err:
        logging.warning("Couldn't find root resource. %s", err)
        return None
    
    
def get_list_dict(pathtofile, fieldnames):
    """
    Gets a list of dictionaries from a csv file

    """

    ret = []
    with open(pathtofile, 'rU') as f:
        rows = unicodecsv.DictReader(f, fieldnames=fieldnames, 
            encoding='utf-8-sig', delimiter=',', restkey='ADDITIONAL', restval='MISSING')
        rows.next() # skip header row
        for row in rows:  
            ret.append(row)
    return ret